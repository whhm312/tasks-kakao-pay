# 카카오페이 뿌리기 기능 구현하기



### -  개발환경

- 프레임워크 : Spring Boot 2.3.3, MyBatis
- DB : MySQL
- 그 외 사용한 라이브러리 : Maven, Swagger 2.9.2, log4j2, Map Struct



## 1. 문제 해결 전략

### 1.1 뿌리기 Token 생성

- 영어 대소문자와 숫자를 조합하여 랜덤 문자열을 생성.
- 중복되는 경우가 있을 경우 다시 시도하도록 처리, 다시 시도 하는 횟수는 properties로 관리.
- 해당 횟수만큼 시도해도 유니크한 키를 생성하지 못하는 경우, 실패 에러를 내림.

### 1.2 10분, 7일의 유효 시간 체크

- MySQL에서 INTERVAL을 사용하여 분과 시간을 각각 계산.
- 유효한 분과 일자가 변경 가능하도록 properties로 관리.

### 1.3 뿌릴 금액 나누기

- 인원으로 총액을 나눈 후 배열에 저장, 나머지가 있는 경우 랜덤으로 배열을 선택해서 나머지를 해당 배열에 저장.

### 1.4 시나리오상의 제약 사항 처리

- 알맞은 Http 상태코드와 각 상황을 설명하는 에러 코드, 내용을 내리도록 구상 및 구현.

### 1.5 API 문서

- Swagger를 이용하여 출력하려고 했지만, 에러 코드를 설명하는 부분이 필요하여 커스터마이징함.

### 1.6 API 설계

- 명사 결정의 경우 돈(Money)로 하기 보다는 행운(Luck)이라고 표현.
- Token를 Lucks의 Document로 사용.
- 뿌리기를 Post와 /bless(동사) 로 처리하고 결과는 201로 적용.
- 받기를 Post와 /grab(동사) 로 처리하고 결과는 201로 적용.
- 조회는 Get과 /token로 처리하고 결과는 리스트를 포함한 조회 결과를 200으로 적용.

### 1.7 통합 테스트

- Spring Boot 에서 제공하는 통합 테스트 예제를 적용.
- 뿌린 후, 결과값을 이용하여 받고, 그 후에 조회 하도록 테스트 순서를 @TestMethodOrder를 사용하여 고정함.
- 통합 테스트를 진행할 때 Port가 중복되지 않도록 Random Port 설정.
- Map Struct의 경우에는 Mappers.getMapper(..)를 사용하여 테스트 진행.

### 1.8 Database

- H2 In memory의 경우에는 서버가 재부팅 될 때 노트북이 느려지는 상황이 발생해서 로컬에 MySQL을 설치 하여 이용하도록 결정.

### 1.9 유니크한 Token

- 3자리의 문자열로 유니크한 Token으로 사용할 수 없어서 사용자 정보와 대화방 정보, 토큰이 생성된 날짜(7일 이전)과 함께 사용. 

### 1.10 Bean Mapping

- 요청 받은 데이터, 응답 할 데이터를 MapStruct에 위임.

### 1.11 Logging

- 어떤 Request가 요청이 왔고, 어떤 결과를 응답했는지 로그 작업.
- 실행된 쿼리 로그 작업.
- Exception이 나는 경우에 Http 상태 코드와 에러 코드, 메세지 로그 작업.



## 2. 개발

1. API 설계
2. 통합 Test Case 작성
3. Controller, Service 작성
4. DB 설계
5. DAO 작성
6. Maven test로 빌드하여 확인 후 Commit

